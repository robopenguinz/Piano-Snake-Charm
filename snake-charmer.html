<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Snake Charmer</title>
  <link rel="stylesheet" href="snake-charmer(1).css">
  <script src="https://cdn.jsdelivr.net/npm/webmidi@latest/dist/iife/webmidi.iife.js"></script>
</head>
<body>

<!-- Background music (src set by JS) -->
<audio id="bgmusic" loop></audio>

<!-- Left side overlay -->
<div style="position:fixed;top:0;left:0;width:750px;height:100%;background:rgba(128,128,128,0.75);pointer-events:none;z-index:10;">
  <img src="assets/piano.png" style="position:fixed; bottom: 0;">
</div>

<!-- Right side snake + basket -->
<div style="position:fixed;right:5%;top:50%;transform:translateY(-50%);width:200px;height:200px;pointer-events:none;z-index:20;">
  <div style="position:absolute;top:-44px;right:-30px;width:160px;pointer-events:none;">
    <div style="font-family:Arial,sans-serif;font-size:0.6rem;color:white;text-align:center;margin-bottom:3px;letter-spacing:0.1em;text-shadow:0 0 6px #000;">ANGER</div>
    <div style="width:160px;height:12px;background:rgba(0,0,0,0.5);border-radius:6px;overflow:hidden;border:1px solid rgba(255,255,255,0.2);">
      <div id="anger-bar" style="height:100%;width:100%;background:linear-gradient(90deg,#e8c97a,#e87a7a);border-radius:6px;transition:width 0.2s ease;"></div>
    </div>
  </div>
  <img src="assets/angry (1).png" id="snake-img" style="position:absolute;width:200%;right:50%;image-rendering:pixelated;animation:bob 1.8s ease-in-out infinite;">
  <img src="assets/basket.png" style="position:absolute;bottom:0;width:200%;right:50%;top:-20%;image-rendering:pixelated;">
</div>

<!-- Timer -->
<div id="timer" style="position:fixed;top:16px;right:20px;font-family:Arial,sans-serif;font-size:2rem;font-weight:bold;color:white;text-shadow:0 0 10px rgba(0,0,0,0.8);z-index:100;">60</div>

<!-- Combo display -->
<div id="combo" style="position:fixed;bottom:30px;right:20px;font-family:Arial,sans-serif;font-size:1.4rem;font-weight:bold;color:#e8c97a;text-shadow:0 0 12px #e8c97a;z-index:100;opacity:0;transition:opacity 0.3s;"></div>

<!-- Level title -->
<div id="level-title" style="position:fixed;top:16px;left:50%;transform:translateX(-50%);font-family:Arial,sans-serif;font-size:1rem;font-weight:bold;color:rgba(255,255,255,0.6);letter-spacing:0.15em;text-transform:uppercase;z-index:100;"></div>

<style>
@keyframes bob {
  0%, 100% { transform: translateY(0px); }
  50%       { transform: translateY(-18px); }
}
@keyframes slideDown {
  0%   { transform: translateY(0px);   opacity: 1; }
  100% { transform: translateY(300px); opacity: 0; }
}
</style>

<script>
  // ‚îÄ‚îÄ LEVEL DEFINITIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const LEVELS = [
    {
      index: 0,
      title: "Vienna",
      subtitle: "Austria ¬∑ Classical ¬∑ Major Scale",
      music: "assets/classical.mp3",
      scaleIndex: 0,   // Major
      angerRefillBase: 0.15,
      angerRefillMax:  0.45,
    },
    {
      index: 1,
      title: "Tehran",
      subtitle: "Iran ¬∑ Arabic ¬∑ Harmonic Minor",
      music: "assets/arabic.mp3",
      scaleIndex: 1,   // Harmonic Minor
      angerRefillBase: 0.22,
      angerRefillMax:  0.58,
    },
    {
      index: 2,
      title: "Dublin",
      subtitle: "Ireland ¬∑ Irish Folk ¬∑ Pentatonic",
      music: "assets/irish.mp3",
      scaleIndex: 2,   // Pentatonic
      angerRefillBase: 0.30,
      angerRefillMax:  0.70,
    },
    {
      index: 3,
      title: "Java",
      subtitle: "Indonesia ¬∑ Gamelan ¬∑ Pelog",
      music: "assets/gamelan.mp3",
      scaleIndex: 3,   // Pelog Bem
      angerRefillBase: 0.38,
      angerRefillMax:  0.82,
    },
    {
      index: 4,
      title: "Berlin",
      subtitle: "Germany ¬∑ Techno ¬∑ Chromatic",
      music: "assets/techno.mp3",
      scaleIndex: 4,   // Pelog Barang (repurposed as chromatic-ish)
      angerRefillBase: 0.50,
      angerRefillMax:  1.00,
    },
  ];

  // Read level from URL param, clamp to valid range
  const params = new URLSearchParams(window.location.search);
  const levelIndex = Math.min(Math.max(parseInt(params.get("level") || "0"), 0), LEVELS.length - 1);
  const LEVEL = LEVELS[levelIndex];

  // Set page title and level label
  document.title = LEVEL.title;
  document.getElementById("level-title").textContent = `${LEVEL.title} ‚Äî ${LEVEL.subtitle}`;

  // Set background music
  const bgmEl = document.getElementById("bgmusic");
  bgmEl.src = LEVEL.music;

  let gameOver = false;

  let timeLeft = 60;
  const timerEl = document.getElementById("timer");
  const timerInterval = setInterval(() => {
    if (gameOver) return;
    timeLeft--;
    timerEl.textContent = timeLeft;
    if (timeLeft <= 10) timerEl.style.color = "#e87a7a";
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      clearInterval(angerRefillInterval);
      gameOver = true;
      showOverlay("Game Over", "Time's up!", "#e87a7a", "Retry", "location.reload()");
    }
  }, 1000);

  let anger = 100;
  const angerBar = document.getElementById("anger-bar");

  const angerRefillInterval = setInterval(() => {
    if (gameOver) return;
    // Higher levels refill faster
    const refillRate = LEVEL.angerRefillBase + ((100 - anger) / 100) * LEVEL.angerRefillMax;
    anger = Math.min(100, anger + refillRate);
    angerBar.style.width = anger + "%";
    updateSnakeImage();
  }, 100);

  let comboCount = 0;
  const comboEl = document.getElementById("combo");
  let comboTimeout = null;

  function updateCombo(scoreValue) {
    if (scoreValue > 0) comboCount++;
    else comboCount = 0;
    if (comboCount >= 2) {
      comboEl.textContent = `x${comboCount} COMBO`;
      comboEl.style.opacity = "1";
      clearTimeout(comboTimeout);
      comboTimeout = setTimeout(() => { comboEl.style.opacity = "0"; }, 1500);
    } else {
      comboEl.style.opacity = "0";
    }
  }

  function getComboMultiplier() {
    if (comboCount < 2) return 1.0;
    return Math.pow(1.5, comboCount);
  }

  function drainAnger(scoreValue) {
    if (gameOver) return;
    if (scoreValue <= 0) return;
    const resistance = 1 + ((100 - anger) / 100) * 1.2;
    const drain = (scoreValue * 10 * getComboMultiplier()) / resistance;
    anger = Math.max(0, anger - drain);
    angerBar.style.width = anger + "%";
    updateSnakeImage();
    if (anger <= 0) {
      gameOver = true;
      clearInterval(timerInterval);
      clearInterval(angerRefillInterval);
      const snakeEl = document.getElementById("snake-img");
      snakeEl.style.animation = "slideDown 3s ease-in forwards";

      const isLast = levelIndex >= LEVELS.length - 1;
      const nextAction = isLast
        ? "window.location.href='index.html'"
        : `window.location.href='snake-charmer.html?level=${levelIndex + 1}'`;
      const nextLabel = isLast ? "Back to Menu" : "Next Level";
      const nextSubtitle = isLast
        ? "You've charmed all the snakes!"
        : `Next: ${LEVELS[levelIndex + 1].title} ‚Äî ${LEVELS[levelIndex + 1].subtitle}`;

      setTimeout(() => {
        showOverlay("You Win! üéµ", nextSubtitle, "#7ae8a0", nextLabel, nextAction);
      }, 3000);
    }
  }

  function updateSnakeImage() {
    const snakeEl = document.getElementById("snake-img");
    if (!snakeEl || gameOver) return;
    let newSrc;
    if (anger > 50)      newSrc = "assets/angry (1).png";
    else if (anger > 25) newSrc = "assets/neutral (1).png";
    else                 newSrc = "assets/calm (1).png";
    if (snakeEl.getAttribute("src") !== newSrc) snakeEl.setAttribute("src", newSrc);
  }

  function showOverlay(title, subtitle, color, btnText, btnAction) {
    const overlay = document.createElement("div");
    overlay.style.cssText = "position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;font-family:Arial,sans-serif;color:white;text-align:center;padding:20px;";
    overlay.innerHTML = `
      <h1 style="font-size:4rem;margin-bottom:0.2em;color:${color};">${title}</h1>
      <p style="color:#aaa;margin-bottom:2rem;font-size:1.1rem;">${subtitle}</p>
      <button onclick="${btnAction}" style="padding:14px 36px;font-size:1.2rem;background:${color};color:#111;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">${btnText}</button>
    `;
    document.body.appendChild(overlay);
  }
</script>

<h1 id="page-h1">Vienna</h1>
<a href="index.html" style="position:fixed;top:16px;left:20px;color:#888;font-size:0.8rem;font-family:Arial,sans-serif;text-decoration:none;z-index:100;">‚Üê Menu</a>

<script>
  // Update h1 to match level
  document.getElementById("page-h1").textContent = LEVEL.title;
</script>

<script>
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

let pianoBuffer = null;
fetch("assets/piano.mp3")
  .then(r => r.arrayBuffer())
  .then(ab => audioCtx.decodeAudioData(ab))
  .then(buf => { pianoBuffer = buf; })
  .catch(err => console.warn("piano.mp3 load failed:", err));

function playNote(notenum, velocity = 1) {
  if (audioCtx.state === "suspended") audioCtx.resume();
  const gain = audioCtx.createGain();
  gain.gain.value = Math.min(1.0, 0.8 * velocity);
  gain.connect(audioCtx.destination);

  if (pianoBuffer) {
    const src = audioCtx.createBufferSource();
    src.buffer = pianoBuffer;
    src.playbackRate.value = Math.pow(2, (notenum - 60) / 12);
    src.connect(gain);
    src.start();
  } else {
    const osc = audioCtx.createOscillator();
    osc.type = "sine";
    osc.frequency.value = 440 * Math.pow(2, (notenum - 69) / 12);
    osc.connect(gain);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.4);
  }
}

function startMusic() {
  const bgm = document.getElementById("bgmusic");
  if (!bgm) return;
  bgm.volume = 0.15;
  if (audioCtx.state === "suspended") audioCtx.resume();
  if (bgm.paused) bgm.play().catch(() => {});
}

const indicator = document.createElement("div");
indicator.style.cssText = "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);font-size:8rem;font-weight:bold;pointer-events:none;z-index:1000;transition:transform 0.1s ease-out,opacity 0.3s ease;opacity:0;text-shadow:0 0 40px currentColor;";
document.body.appendChild(indicator);

let indicatorTimeout = null;

function showIndicator(scoreValue) {
  clearTimeout(indicatorTimeout);
  if (scoreValue === -1)     { indicator.textContent = "‚úó"; indicator.style.color = "#e87a7a"; }
  else if (scoreValue === 0) { indicator.textContent = "‚Äì"; indicator.style.color = "#888"; }
  else if (scoreValue >= 0.5){ indicator.textContent = "‚úì"; indicator.style.color = "#7ae8a0"; }
  else                       { indicator.textContent = "~"; indicator.style.color = "#e8c97a"; }
  indicator.style.opacity = "1";
  indicator.style.transform = "translate(-50%, -50%) scale(1)";
  indicatorTimeout = setTimeout(() => {
    indicator.style.opacity = "0";
    indicator.style.transform = "translate(-50%, -50%) scale(0.6)";
  }, 600);
}

const NOTE_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

const activeNotes = {};

function startNote(midiNote, noteName, isCorrect) {
  if (activeNotes[midiNote]) return;
  const xPct = midiNote * 30 - 1425;
  const color = isCorrect === null ? "#888" : isCorrect ? "#7ae8a0" : "#e87a7a";

  const container = document.createElement("div");
  container.style.cssText = `position:fixed;left:${xPct}px;bottom:0;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;pointer-events:none;z-index:500;`;

  const rect = document.createElement("div");
  rect.style.cssText = `width:18px;height:0px;background:${color};opacity:0.35;border-radius:4px 4px 0 0;`;

  const label = document.createElement("div");
  label.textContent = noteName;
  label.style.cssText = `font-size:0.85rem;font-weight:bold;font-family:Arial,sans-serif;color:${color};text-shadow:0 0 8px ${color};margin-top:2px;white-space:nowrap;`;

  container.appendChild(rect);
  container.appendChild(label);
  document.body.appendChild(container);

  const startTime = Date.now();
  const growInterval = setInterval(() => {
    const px = Math.min((Date.now() - startTime) / 1000 * 120, window.innerHeight * 0.9);
    rect.style.height = px + "px";
  }, 16);

  activeNotes[midiNote] = { container, rect, startTime, growInterval };
}

function releaseNote(midiNote) {
  const note = activeNotes[midiNote];
  if (!note) return;
  clearInterval(note.growInterval);
  delete activeNotes[midiNote];
  const { container, rect } = note;
  const heldHeight = parseFloat(rect.style.height) || 4;
  const duration = Math.max(2, heldHeight / 80);
  container.style.transition = `transform ${duration}s linear, opacity 0.4s ease ${duration - 0.4}s`;
  container.style.transform = `translateX(-50%) translateY(calc(-100vh - ${heldHeight + 40}px))`;
  container.style.opacity = "0";
  setTimeout(() => container.remove(), duration * 1000);
}

const scales = [
    [48, 50, 52, 53, 55, 57, 59, 60, 62, 64, 65, 67, 69, 71, 72], // Major
    [48, 50, 51, 53, 55, 56, 59, 60, 62, 63, 65, 67, 68, 71, 72], // Harmonic Minor
    [48, 50, 52, 55, 57, 60, 62, 64, 67, 69, 72],                  // Pentatonic
    [48, 49, 52, 55, 56, 60, 61, 64, 67, 68, 72],                  // Pelog Bem
    [49, 52, 55, 56, 59, 61, 64, 67, 68, 71]                       // Pelog Barang
];

let last = [];
let lastNote = null;
let lastNoteTime = 0;

function score(level, note) {
    const now = Date.now();
    const timeSinceLast = now - lastNoteTime;

    if (timeSinceLast < 250 || note === lastNote) {
      lastNote = note;
      lastNoteTime = now;
      last.push(note);
      if (last.length > 6) last = last.slice(-6);
      return 0;
    }

    lastNote = note;
    lastNoteTime = now;
    last.push(note);
    if (!scales[level].includes(note)) return -1.0;
    if (last.length < 6) return 0.5;
    if (last.length > 6) last = last.slice(-6);
    for (let i = 0; i < 5; i++) {
        if (last[i] === note) return (i * 0.1 + 0.2);
    }
    return 0.5;
}

WebMidi.enable().then(setupMidi).catch(err => console.error("MIDI enable failed:", err));

function setupMidi() {
  WebMidi.addListener("connected", () => WebMidi.inputs.forEach(attachListeners));
  WebMidi.inputs.forEach(attachListeners);
}

function attachListeners(input) {
  input.removeListener("noteon");
  input.removeListener("noteoff");
  input.addListener("noteon", e => {
    startMusic();
    playNote(e.note.number, e.velocity);
    const scoreValue = score(LEVEL.scaleIndex, e.note.number);
    const noteName = NOTE_NAMES[e.note.number % 12] + e.note.octave;
    showIndicator(scoreValue);
    const noteColor = scoreValue === 0 ? null : scoreValue > 0;
    startNote(e.note.number, noteName, noteColor);
    updateCombo(scoreValue);
    drainAnger(scoreValue);
  });
  input.addListener("noteoff", e => releaseNote(e.note.number));
}
</script>

</body>
</html>